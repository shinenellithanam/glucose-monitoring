<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Blood Glucose Monitoring</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    
    <!-- Babel & Icons -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@0.321.0/dist/umd/lucide.min.js"></script>
    
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .lucide-icon { display: inline-block; vertical-align: middle; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { 
            LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer 
        } = window.Recharts;

        // Revised Icon component to use lucide.createIcons which is safer in UMD
        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);

            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    window.lucide.createIcons({
                        attrs: {
                            class: `lucide-icon ${className}`,
                            width: size,
                            height: size,
                            'stroke-width': 2.5
                        },
                        nameAttr: 'data-lucide'
                    });
                }
            }, [name, size, className]);

            return (
                <i 
                    ref={iconRef} 
                    data-lucide={name.toLowerCase()} 
                    style={{ width: size, height: size, display: 'inline-block' }}
                ></i>
            );
        };

        const CATEGORIES = [
            { id: 1, label: "Before breakfast", type: "fasting" },
            { id: 2, label: "2hrs after breakfast", type: "postprandial" },
            { id: 3, label: "Before Lunch", type: "postprandial" },
            { id: 4, label: "2hrs after Lunch", type: "postprandial" },
            { id: 5, label: "Before Dinner", type: "postprandial" },
            { id: 6, label: "2hrs after Dinner", type: "postprandial" }
        ];

        const RANGES = {
            fasting: { min: 3.3, max: 5.5 },
            postprandial: { min: 3.3, max: 10.9 }
        };

        function App() {
            const [user, setUser] = useState(() => {
                const saved = localStorage.getItem('bgm_user');
                return saved ? JSON.parse(saved) : { name: '', hcNumber: '' };
            });

            const [logs, setLogs] = useState(() => {
                const saved = localStorage.getItem('bgm_logs');
                return saved ? JSON.parse(saved) : [];
            });

            const [activeTab, setActiveTab] = useState('add');
            const [formData, setFormData] = useState({
                date: new Date().toISOString().split('T')[0],
                categoryId: 1,
                value: ''
            });

            useEffect(() => {
                localStorage.setItem('bgm_user', JSON.stringify(user));
            }, [user]);

            useEffect(() => {
                localStorage.setItem('bgm_logs', JSON.stringify(logs));
            }, [logs]);

            const getStatus = (value, categoryId) => {
                const val = parseFloat(value);
                const category = CATEGORIES.find(c => c.id === parseInt(categoryId));
                const range = RANGES[category.type];
                if (val < range.min) return 'low';
                if (val > range.max) return 'high';
                return 'normal';
            };

            const handleAddLog = (e) => {
                e.preventDefault();
                if (!formData.value || !user.name) return;
                const newLog = {
                    id: Date.now(),
                    ...formData,
                    value: parseFloat(formData.value),
                    status: getStatus(formData.value, formData.categoryId)
                };
                setLogs([newLog, ...logs]);
                setFormData({ ...formData, value: '' });
                setActiveTab('history');
            };

            const generatePDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(20);
                doc.text('Blood Glucose Monitoring Report', 14, 20);
                doc.setFontSize(12);
                doc.text(`Patient: ${user.name}`, 14, 30);
                doc.text(`HC#: ${user.hcNumber}`, 14, 37);

                const tableData = logs.map(log => [
                    log.date,
                    CATEGORIES.find(c => c.id === parseInt(log.categoryId))?.label,
                    `${log.value} mmol/L`,
                    log.status.toUpperCase()
                ]);

                doc.autoTable({
                    startY: 45,
                    head: [['Date', 'Category', 'Value', 'Status']],
                    body: tableData,
                    headStyles: { fillColor: [79, 70, 229] },
                });
                doc.save(`${user.name}_report.pdf`);
            };

            const statsData = useMemo(() => {
                const sorted = [...logs].sort((a, b) => new Date(a.date) - new Date(b.date));
                const dailyTrends = sorted.reduce((acc, log) => {
                    const date = log.date;
                    if (!acc[date]) acc[date] = { date, value: 0, count: 0 };
                    acc[date].value += log.value;
                    acc[date].count += 1;
                    return acc;
                }, {});
                return Object.values(dailyTrends).map(d => ({
                    date: d.date,
                    avg: (d.value / d.count).toFixed(1)
                })).slice(-10);
            }, [logs]);

            const StatusBadge = ({ status }) => {
                const colors = {
                    normal: 'bg-green-100 text-green-700',
                    high: 'bg-red-100 text-red-700',
                    low: 'bg-yellow-100 text-yellow-700'
                };
                return (
                    <span className={`px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider ${colors[status]}`}>
                        {status}
                    </span>
                );
            };

            return (
                <div className="min-h-screen pb-16 md:pb-0 md:pl-64">
                    {/* Sidebar Desktop */}
                    <aside className="fixed left-0 top-0 bottom-0 w-64 bg-white border-r border-slate-200 hidden md:flex flex-col p-4 z-20">
                        <div className="flex items-center gap-2 mb-8 text-indigo-600 px-2">
                            <Icon name="Activity" size={28} />
                            <h1 className="font-bold text-lg leading-tight">Glucose Tracker</h1>
                        </div>
                        <nav className="space-y-1 flex-1">
                            {['add', 'history', 'stats'].map(tab => (
                                <button 
                                    key={tab}
                                    onClick={() => setActiveTab(tab)} 
                                    className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all capitalize ${activeTab === tab ? 'bg-indigo-600 text-white font-medium shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}
                                >
                                    <Icon name={tab === 'add' ? 'Plus' : tab === 'history' ? 'History' : 'Bar-Chart-3'} size={18} />
                                    <span className="ml-2">{tab === 'add' ? 'Add Entry' : tab}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="mt-auto pt-4 border-t border-slate-100">
                            <button onClick={() => setActiveTab('profile')} className="flex items-center gap-3 w-full px-2 py-2 hover:bg-slate-50 rounded-lg">
                                <div className="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold text-sm">
                                    {user.name ? user.name[0].toUpperCase() : <Icon name="User" size={16}/>}
                                </div>
                                <div className="overflow-hidden text-left">
                                    <p className="font-semibold text-xs truncate">{user.name || 'Set Profile'}</p>
                                    <p className="text-[10px] text-slate-400 truncate">{user.hcNumber || 'No HC#'}</p>
                                </div>
                            </button>
                        </div>
                    </aside>

                    {/* Mobile Bottom Nav */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around p-1 md:hidden z-30 shadow-lg">
                        {[
                            { id: 'add', icon: 'Plus', label: 'Add' },
                            { id: 'history', icon: 'History', label: 'Logs' },
                            { id: 'stats', icon: 'Bar-Chart-3', label: 'Stats' },
                            { id: 'profile', icon: 'User', label: 'Profile' }
                        ].map(item => (
                            <button key={item.id} onClick={() => setActiveTab(item.id)} className={`flex flex-col items-center py-2 px-4 rounded-xl ${activeTab === item.id ? 'text-indigo-600' : 'text-slate-400'}`}>
                                <Icon name={item.icon} size={22} />
                                <span className="text-[10px] mt-0.5 font-medium">{item.label}</span>
                            </button>
                        ))}
                    </nav>

                    <header className="bg-white border-b border-slate-200 px-4 py-3 sticky top-0 z-10 md:hidden flex justify-between items-center">
                        <div className="flex items-center gap-2 text-indigo-600">
                            <Icon name="Activity" size={20} />
                            <h1 className="font-bold text-sm uppercase tracking-tight ml-2">Glucose Tracker</h1>
                        </div>
                        <div className="text-[9px] font-black text-slate-300 uppercase tracking-widest">{activeTab}</div>
                    </header>

                    <main className="max-w-2xl mx-auto p-3 md:p-6 animate-fade-in">
                        {(activeTab === 'profile' || !user.name) && (
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
                                <h2 className="text-sm font-black text-slate-400 uppercase mb-4 tracking-wider">Patient Profile</h2>
                                <div className="space-y-3">
                                    <input type="text" className="w-full p-2.5 text-sm rounded-lg border border-slate-200 outline-none focus:ring-1 focus:ring-indigo-500" placeholder="Full Name" value={user.name} onChange={(e) => setUser({...user, name: e.target.value})} />
                                    <input type="text" className="w-full p-2.5 text-sm rounded-lg border border-slate-200 outline-none focus:ring-1 focus:ring-indigo-500" placeholder="Health Card Number" value={user.hcNumber} onChange={(e) => setUser({...user, hcNumber: e.target.value})} />
                                    <button onClick={() => setActiveTab('add')} className="w-full bg-indigo-600 text-white py-2.5 rounded-lg font-bold text-sm">Save Profile</button>
                                </div>
                            </div>
                        )}

                        {activeTab === 'add' && user.name && (
                            <div className="space-y-4">
                                <div className="bg-white p-4 rounded-xl border border-slate-200">
                                    <h2 className="text-base font-bold mb-4 text-slate-800">New Entry</h2>
                                    <form onSubmit={handleAddLog} className="space-y-4">
                                        <div className="grid gap-3">
                                            <input type="date" className="w-full p-2.5 text-sm rounded-lg border border-slate-200 bg-slate-50" value={formData.date} onChange={(e) => setFormData({...formData, date: e.target.value})} />
                                            <select className="w-full p-2.5 text-sm rounded-lg border border-slate-200 bg-slate-50" value={formData.categoryId} onChange={(e) => setFormData({...formData, categoryId: e.target.value})}>
                                                {CATEGORIES.map(cat => <option key={cat.id} value={cat.id}>{cat.label}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-[10px] font-bold text-slate-400 uppercase mb-1">mmol/L</label>
                                            <input type="number" step="0.1" placeholder="0.0" className="w-full p-4 text-3xl font-black rounded-xl border-2 border-slate-100 text-center outline-none focus:border-indigo-500" value={formData.value} onChange={(e) => setFormData({...formData, value: e.target.value})} required />
                                        </div>
                                        <button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold text-sm shadow-lg active:scale-95 transition-transform">Record Reading</button>
                                    </form>
                                </div>
                                <div className="bg-slate-800 text-white p-3 rounded-xl flex justify-around text-[10px] font-bold text-center">
                                    <div><p className="text-slate-400">FASTING</p><p>3.3 - 5.5</p></div>
                                    <div className="w-px bg-slate-700"></div>
                                    <div><p className="text-slate-400">OTHERS</p><p>Up to 10.9</p></div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="space-y-3">
                                <div className="flex justify-between items-center px-1">
                                    <h2 className="text-base font-bold text-slate-800">Records</h2>
                                    <button onClick={generatePDF} disabled={logs.length === 0} className="text-[10px] font-black uppercase text-indigo-600 bg-indigo-50 px-3 py-2 rounded-lg">Export PDF</button>
                                </div>
                                {logs.length === 0 ? (
                                    <p className="text-center py-12 text-slate-400 text-xs italic">No readings recorded yet.</p>
                                ) : (
                                    <div className="space-y-2">
                                        {logs.map(log => (
                                            <div key={log.id} className="bg-white p-3 rounded-xl border border-slate-100 flex items-center justify-between shadow-sm">
                                                <div className="flex items-center gap-3">
                                                    <div className={`w-10 h-10 rounded-lg flex items-center justify-center font-black text-sm ${log.status === 'normal' ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'}`}>
                                                        {log.value}
                                                    </div>
                                                    <div>
                                                        <p className="font-bold text-xs text-slate-800">{CATEGORIES.find(c => c.id == log.categoryId)?.label}</p>
                                                        <p className="text-[10px] text-slate-400">{new Date(log.date).toLocaleDateString(undefined, {month:'short', day:'numeric'})}</p>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <StatusBadge status={log.status} />
                                                    <button onClick={() => setLogs(logs.filter(l => l.id !== log.id))} className="p-1.5 text-slate-200 hover:text-red-500">
                                                        <Icon name="Trash-2" size={16} />
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'stats' && (
                            <div className="space-y-4">
                                <h2 className="text-base font-bold text-slate-800">Analytics</h2>
                                {logs.length < 3 ? (
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 text-center text-xs text-slate-400">Need 3+ logs for data visualization.</div>
                                ) : (
                                    <>
                                        <div className="grid grid-cols-3 gap-2">
                                            <div className="bg-white p-2 rounded-xl text-center border border-slate-100">
                                                <p className="text-[8px] font-black text-slate-400 uppercase">AVG</p>
                                                <p className="text-lg font-black text-indigo-600">{(logs.reduce((s,l)=>s+l.value,0)/logs.length).toFixed(1)}</p>
                                            </div>
                                            <div className="bg-white p-2 rounded-xl text-center border border-slate-100">
                                                <p className="text-[8px] font-black text-slate-400 uppercase">NORM</p>
                                                <p className="text-lg font-black text-green-600">{Math.round((logs.filter(l=>l.status==='normal').length/logs.length)*100)}%</p>
                                            </div>
                                            <div className="bg-white p-2 rounded-xl text-center border border-slate-100">
                                                <p className="text-[8px] font-black text-slate-400 uppercase">COUNT</p>
                                                <p className="text-lg font-black text-slate-800">{logs.length}</p>
                                            </div>
                                        </div>
                                        <div className="bg-white p-3 rounded-xl border border-slate-100 h-56">
                                            <p className="text-[9px] font-black text-slate-400 uppercase mb-4">Trend (10 days)</p>
                                            <div className="h-40 w-full">
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <LineChart data={statsData}>
                                                        <XAxis dataKey="date" hide />
                                                        <YAxis hide domain={['auto', 'auto']} />
                                                        <Tooltip contentStyle={{fontSize:'10px', borderRadius:'8px'}} />
                                                        <Line type="monotone" dataKey="avg" stroke="#4f46e5" strokeWidth={3} dot={{r:3}} />
                                                    </LineChart>
                                                </ResponsiveContainer>
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);
    </script>
</body>
</html>
